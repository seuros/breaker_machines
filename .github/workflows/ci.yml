name: CI

on:
  push:
    branches:
      - master

  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Test the Rust crate independently
  test-rust-crate:
    runs-on: ubuntu-latest
    name: Rust Crate Tests

    steps:
      - uses: actions/checkout@v5

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ext/breaker_machines_native/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Rust formatting
        run: |
          cd ext/breaker_machines_native/core
          cargo fmt --check

      - name: Run Clippy
        run: |
          cd ext/breaker_machines_native/core
          cargo clippy

      - name: Build Rust crate
        run: |
          echo "::group::Building Rust crate"
          cd ext/breaker_machines_native/core
          time cargo build --release
          echo "::endgroup::"

      - name: Run Rust tests
        run: |
          echo "::group::Running Rust tests"
          cd ext/breaker_machines_native/core
          time cargo test --all
          echo "::endgroup::"

      - name: Check crate can be published
        run: |
          cd ext/breaker_machines_native/core
          cargo package --allow-dirty

  # Test with pure Ruby backend (no native extension)
  test-ruby:
    runs-on: ubuntu-latest
    name: Ruby ${{ matrix.ruby }} / Rails ${{ matrix.rails }} (Pure Ruby)
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - "3.4.4"
        rails:
          - "8.0.4"
          - "8.1.1"
    env:
      ACTIVERECORD_VERSION: ${{ matrix.rails }}
      BREAKER_MACHINES_NATIVE: "0"  # Disable native extension

    steps:
      - uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true

      - name: Run tests (Pure Ruby)
        run: |
          echo "::group::Running tests with Pure Ruby backend"
          time bin/rails test
          echo "::endgroup::"

      - name: Verify pure Ruby mode
        run: |
          bundle exec ruby -Ilib -e "
            require 'breaker_machines'
            if BreakerMachines.native_available?
              puts '❌ ERROR: Native extension should not be available'
              exit 1
            else
              puts '✅ Pure Ruby backend active'
            end
          "

  # Test with native FFI backend
  test-native:
    runs-on: ubuntu-latest
    name: Ruby ${{ matrix.ruby }} / Rails ${{ matrix.rails }} (Native FFI)
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - "3.4.4"
        rails:
          - "8.0.4"
          - "8.1.1"
    env:
      ACTIVERECORD_VERSION: ${{ matrix.rails }}
      BREAKER_MACHINES_NATIVE: "1"  # Enable native extension

    steps:
      - uses: actions/checkout@v5

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ext/breaker_machines_native/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true

      - name: Build native extension
        run: |
          echo "::group::Building native extension"
          cd ext/breaker_machines_native
          bundle exec ruby extconf.rb
          make
          mkdir -p breaker_machines_native
          cp breaker_machines_native.* breaker_machines_native/ 2>/dev/null || true
          cd ../..
          echo "::endgroup::"

      - name: Run tests (Native FFI)
        run: |
          echo "::group::Running tests with Native FFI backend"
          time ruby -Ilib:ext/breaker_machines_native bin/rails test
          echo "::endgroup::"

      - name: Verify native mode
        run: |
          bundle exec ruby -Ilib:ext/breaker_machines_native -e "
            require 'breaker_machines'
            ENV['BREAKER_MACHINES_NATIVE'] = '1'
            require 'breaker_machines/native_speedup'
            if BreakerMachines.native_available?
              puts '✅ Native FFI backend active'
            else
              puts '❌ ERROR: Native extension should be available'
              exit 1
            end
          "
